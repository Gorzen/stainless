
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Ghost Context &#8212; Stainless 3.0 documentation</title>
    <link rel="stylesheet" href="_static/css/stainless.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Limitations of Verification" href="limitations.html" />
    <link rel="prev" title="Working With Existing Code" href="wrap.html" /> 
  </head><body>
    <div class="header-wrapper">
      <div class="header">
        <div class="left">
            <div class="headertitle"><a
              href="index.html">Stainless Documentation</a></div>
            <div class="rel">
              <a href="wrap.html">Working With Existing Code</a> |
              <a class="uplink" href="index.html">Contents</a>
              | <a href="limitations.html">Limitations of Verification</a>
            </div>
        </div>
        <div class="right">
          <form class="search" action="search.html" method="get">
            <input type="text" name="q" placeholder="Search.." />
            <input type="submit" value="Go" />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
          </form>
        </div>
        <div class="clearer"></div>
       </div>
    </div>

    <div class="content-wrapper">
      <div class="content">
        <div class="document">
            
            
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ghost-context">
<span id="ghost"></span><h1>Ghost Context<a class="headerlink" href="#ghost-context" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>When verifying code, one often needs to introduce lemmas, auxiliary functions,
additional fields and parameters, and contracts, whose only function is to specify
and prove that some properties are satisfied by the program.</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">stainless.lang._</span>
<span class="k">import</span> <span class="nn">stainless.lang.collection._</span>
<span class="k">import</span> <span class="nn">stainless.lang.annotation._</span>

<span class="k">def</span> <span class="n">isSorted</span><span class="o">(</span><span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">BigInt</span><span class="o">])</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">list</span> <span class="k">match</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Nil</span><span class="o">()</span>                            <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="k">case</span> <span class="nc">Cons</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="nc">Nil</span><span class="o">())</span>                   <span class="k">=&gt;</span> <span class="kc">true</span>
  <span class="k">case</span> <span class="nc">Cons</span><span class="o">(</span><span class="n">x1</span><span class="o">,</span> <span class="nc">Cons</span><span class="o">(</span><span class="n">x2</span><span class="o">,</span> <span class="k">_</span><span class="o">))</span> <span class="k">if</span> <span class="n">x1</span> <span class="o">&gt;</span> <span class="n">x2</span> <span class="k">=&gt;</span> <span class="kc">false</span>
  <span class="k">case</span> <span class="nc">Cons</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">xs</span><span class="o">)</span>                      <span class="k">=&gt;</span> <span class="n">isSorted</span><span class="o">(</span><span class="n">xs</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">sort</span><span class="o">(</span><span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">BigInt</span><span class="o">])</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">BigInt</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="cm">/* ... */</span>
<span class="o">}</span> <span class="n">ensuring</span> <span class="o">{</span> <span class="n">res</span> <span class="k">=&gt;</span>
  <span class="n">res</span><span class="o">.</span><span class="n">contents</span> <span class="o">==</span> <span class="n">list</span><span class="o">.</span><span class="n">contents</span> <span class="o">&amp;&amp;</span>
  <span class="n">isSorted</span><span class="o">(</span><span class="n">res</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
  <span class="n">res</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">l</span><span class="o">.</span><span class="n">size</span>
<span class="o">}</span>
</pre></div>
</div>
<p>One can alleviate this issue by adding the following import:</p>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">stainless.lang.StaticChecks._</span>
</pre></div>
</div>
</div>
<div class="section" id="ghost-annotation">
<h2>Ghost annotation<a class="headerlink" href="#ghost-annotation" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="correctness-check">
<h2>Correctness check<a class="headerlink" href="#correctness-check" title="Permalink to this headline">¶</a></h2>
<p>As part of the verification pipeline, Stainless will check that it never
encounters a <em>ghost expression</em> outside of a <em>ghost context</em>. Should
the check fail, verification will fail and compilation will be aborted.</p>
<p>A <em>ghost expression</em> is any of:</p>
<ul class="simple">
<li>Call to a ghost method</li>
<li>Selection of a ghost field</li>
<li>Instantiation of a ghost class</li>
<li>Reference to a ghost variable</li>
</ul>
<p>A <em>ghost context</em> as any of:</p>
<ul class="simple">
<li>Body of a ghost method</li>
<li>Argument to a ghost parameter (method or class constructor)</li>
<li>Assignment to a ghost variable</li>
<li>Anywhere where a value of type <code class="docutils literal notranslate"><span class="pre">Unit</span></code> is expected</li>
</ul>
</div>
<div class="section" id="ghost-expression-elimination">
<h2>Ghost expression elimination<a class="headerlink" href="#ghost-expression-elimination" title="Permalink to this headline">¶</a></h2>
<p>If the correctness check described in the previous section succeeds, the sbt plugin
will then proceed to eliminate ghost methods and expressions from the programs.</p>
</div>
<div class="section" id="case-study">
<h2>Case study<a class="headerlink" href="#case-study" title="Permalink to this headline">¶</a></h2>
<div class="highlight-scala notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">stainless.lang._</span>
<span class="k">import</span> <span class="nn">stainless.lang.StaticChecks._</span>
<span class="k">import</span> <span class="nn">stainless.collection._</span>
<span class="k">import</span> <span class="nn">stainless.annotation._</span>

<span class="k">import</span> <span class="nn">java.util.ArrayDeque</span>

<span class="k">object</span> <span class="nc">MessageQueue</span> <span class="o">{</span>

  <span class="k">case</span> <span class="k">class</span> <span class="nc">MsgQueue</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span>
    <span class="nd">@extern</span> <span class="nd">@pure</span>
    <span class="n">queue</span><span class="k">:</span> <span class="kt">ArrayDeque</span><span class="o">[</span><span class="kt">A</span><span class="o">],</span>
    <span class="nd">@ghost</span>
    <span class="k">var</span> <span class="n">msgs</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
  <span class="o">)</span> <span class="o">{</span>
    <span class="k">def</span> <span class="n">put</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>

      <span class="n">msgs</span> <span class="k">=</span> <span class="n">msg</span> <span class="o">::</span> <span class="n">msgs</span>
      <span class="nc">_put</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="nd">@extern</span> <span class="nd">@pure</span>
    <span class="k">private</span> <span class="k">def</span> <span class="nc">_put</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">queue</span><span class="o">.</span><span class="n">addFirst</span><span class="o">(</span><span class="n">msg</span><span class="o">)</span>
    <span class="o">}</span>

    <span class="k">def</span> <span class="n">take</span><span class="o">()</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">_take</span><span class="o">()</span>
      <span class="n">msgs</span> <span class="k">=</span> <span class="n">msgs</span><span class="o">.</span><span class="n">tailOption</span><span class="o">.</span><span class="n">getOrElse</span><span class="o">(</span><span class="nc">Nil</span><span class="o">())</span>
      <span class="n">result</span>
    <span class="o">}</span> <span class="n">ensuring</span> <span class="o">{</span> <span class="n">res</span> <span class="k">=&gt;</span>
      <span class="n">res</span> <span class="o">==</span> <span class="n">old</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="n">msgs</span><span class="o">.</span><span class="n">headOption</span>
    <span class="o">}</span>

    <span class="nd">@extern</span> <span class="nd">@pure</span>
    <span class="k">private</span> <span class="k">def</span> <span class="nc">_take</span><span class="o">()</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
      <span class="nc">Option</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="n">pollFirst</span><span class="o">())</span>
    <span class="o">}</span> <span class="n">ensuring</span> <span class="o">{</span> <span class="n">res</span> <span class="k">=&gt;</span>
      <span class="n">res</span> <span class="o">==</span> <span class="n">msgs</span><span class="o">.</span><span class="n">headOption</span>
    <span class="o">}</span>

    <span class="nd">@extern</span> <span class="nd">@pure</span>
    <span class="k">def</span> <span class="n">isEmpty</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">queue</span><span class="o">.</span><span class="n">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="o">}</span> <span class="n">ensuring</span> <span class="o">{</span> <span class="n">res</span> <span class="k">=&gt;</span>
      <span class="n">res</span> <span class="o">==</span> <span class="n">msgs</span><span class="o">.</span><span class="n">isEmpty</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">object</span> <span class="nc">MsgQueue</span> <span class="o">{</span>
    <span class="nd">@extern</span> <span class="nd">@pure</span>
    <span class="k">def</span> <span class="n">empty</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span><span class="k">:</span> <span class="kt">MsgQueue</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
      <span class="nc">MsgQueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayDeque</span><span class="o">(),</span> <span class="nc">Nil</span><span class="o">())</span>
    <span class="o">}</span> <span class="n">ensuring</span> <span class="o">{</span> <span class="n">res</span> <span class="k">=&gt;</span>
      <span class="n">res</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="o">.</span><span class="n">msgs</span><span class="o">.</span><span class="n">isEmpty</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">test</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">queue</span> <span class="k">=</span> <span class="nc">MsgQueue</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>

    <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;World&quot;</span><span class="o">)</span>
    <span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">)</span>

    <span class="n">assert</span><span class="o">(!</span><span class="n">queue</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">take</span><span class="o">()</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;Hello&quot;</span><span class="o">))</span>

    <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">take</span><span class="o">()</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">b</span> <span class="o">==</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;World&quot;</span><span class="o">))</span>
    <span class="n">assert</span><span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="n">isEmpty</span><span class="o">)</span>

    <span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">take</span><span class="o">()</span>
    <span class="n">assert</span><span class="o">(!</span><span class="n">c</span><span class="o">.</span><span class="n">isDefined</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
        </div>
        <div class="sidebar">
          <h3>Table Of Contents</h3>
          <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installing Stainless</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial: Sorting</a></li>
<li class="toctree-l1"><a class="reference internal" href="purescala.html">Pure Scala</a></li>
<li class="toctree-l1"><a class="reference internal" href="library.html">Stainless Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="imperative.html">Imperative</a></li>
<li class="toctree-l1"><a class="reference internal" href="verification.html">Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="neon.html">Proving Theorems</a></li>
<li class="toctree-l1"><a class="reference internal" href="laws.html">Specifying Algebraic Properties</a></li>
<li class="toctree-l1"><a class="reference internal" href="wrap.html">Working With Existing Code</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Ghost Context</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ghost-annotation">Ghost annotation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#correctness-check">Correctness check</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ghost-expression-elimination">Ghost expression elimination</a></li>
<li class="toctree-l2"><a class="reference internal" href="#case-study">Case study</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="limitations.html">Limitations of Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="casestudies.html">Case Studies</a></li>
<li class="toctree-l1"><a class="reference internal" href="options.html">Command Line Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="internals.html">Stainless’ Internals</a></li>
</ul>

        </div>
        <div class="clearer"></div>
      </div>
    </div>

    <div class="footer-wrapper">
      <div class="footer">
        <div class="left">
            <a href="_sources/ghost.rst.txt"
               rel="nofollow">Show Source</a>
        </div>

        <div class="right">
            &copy; Copyright 2009-2018 EPFL, Lausanne.
          Last updated on Dec 10, 2018.
        </div>
        <div class="clearer"></div>
      </div>
    </div>

  </body>
</html>